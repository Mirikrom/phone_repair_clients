{% extends 'base.html' %}

{% block title %}{{ title }} - Telefon Ustaxonasi{% endblock %}

{% block extra_css %}
<style>
.order-form-grid .form-field { min-height: 4.5rem; }
.order-form-grid .form-label { display: block; margin-bottom: 0.35rem; }
.order-form-grid #laminat-section.laminat-hidden { visibility: hidden; pointer-events: none; }
.autocomplete-list {
    position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
    max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #dee2e6;
    border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none; margin-top: 2px;
}
.autocomplete-list.show { display: block; }
.autocomplete-list .item {
    padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.95rem;
    border-bottom: 1px solid #f1f5f9;
}
.autocomplete-list .item:last-child { border-bottom: none; }
.autocomplete-list .item:hover, .autocomplete-list .item.active { background: #eef2ff; }
@media (max-width: 767px) {
    .order-form-grid .form-field { min-height: auto; margin-bottom: 0.5rem; }
    .order-form-grid .d-flex.flex-wrap.gap-3 { gap: 0.75rem !important; }
    .order-form-grid .form-check { min-height: 44px; display: flex; align-items: center; }
    .order-form-grid .d-flex.gap-2.mt-4 { flex-direction: column; }
    .order-form-grid .d-flex.gap-2.mt-4 .btn { width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center mx-0">
    <div class="col-12 col-lg-8 px-0 px-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> {{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" novalidate class="order-form-grid">
                    {% csrf_token %}
                    
                    <div class="row g-3">
                        <div class="col-md-4 form-field position-relative">
                            <label class="form-label">{{ form.phone_model.label }}</label>
                            {{ form.phone_model }}
                            <div id="phone_model_suggest" class="autocomplete-list"></div>
                            {% if form.phone_model.errors %}
                                <div class="text-danger small">{{ form.phone_model.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 form-field position-relative">
                            <label class="form-label">{{ form.required_parts.label }}</label>
                            {{ form.required_parts }}
                            <div id="required_parts_suggest" class="autocomplete-list"></div>
                            {% if form.required_parts.errors %}
                                <div class="text-danger small">{{ form.required_parts.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 form-field d-flex align-items-end pb-2">
                            <div class="form-check">
                                {{ form.zapchast_olib_kelish_kerak }}
                                <label class="form-check-label" for="id_zapchast_olib_kelish_kerak">Zapchast olib kelish kerak</label>
                            </div>
                        </div>
                        <div class="col-md-6 form-field">
                            <label class="form-label">{{ form.client_phone.label }}</label>
                            <div class="input-group">
                                <span class="input-group-text">+998</span>
                                <input type="text" name="client_phone" value="{{ form.client_phone.value|default:'' }}" class="form-control" maxlength="20" inputmode="numeric" pattern="[0-9\s]*">
                            </div>
                            {% if form.client_phone.errors %}
                                <div class="text-danger small">{{ form.client_phone.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 form-field">
                            <label class="form-label">{{ form.repair_cost.label }}</label>
                            {{ form.repair_cost }}
                            {% if form.repair_cost.errors %}
                                <div class="text-danger small">{{ form.repair_cost.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 form-field">
                            <label class="form-label">{{ form.deposit_amount.label }}</label>
                            {{ form.deposit_amount }}
                            {% if form.deposit_amount.errors %}
                                <div class="text-danger small">{{ form.deposit_amount.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12 form-field">
                            <label class="form-label">{{ form.screen_type.label }}</label>
                            <div class="d-flex flex-wrap gap-3">
                                {% for value, label in form.fields.screen_type.widget.choices %}
                                    {% if value %}
                                    <div class="form-check">
                                        <input class="form-check-input deselect-radio" type="radio" name="screen_type" value="{{ value }}" id="id_screen_{{ forloop.counter }}" {% if form.screen_type.value == value %}checked{% endif %}>
                                        <label class="form-check-label" for="id_screen_{{ forloop.counter }}">{{ label }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if form.screen_type.errors %}
                                <div class="text-danger small">{{ form.screen_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <div id="laminat-section" class="laminat-hidden">
                                <label class="form-label">Laminat bo'limi</label>
                                <div class="d-flex flex-wrap gap-3">
                                    {% for value, label in form.fields.laminat.widget.choices %}
                                        {% if value %}
                                        <div class="form-check">
                                            <input class="form-check-input deselect-radio laminat-radio" type="radio" name="laminat" value="{{ value }}" id="id_laminat_{{ forloop.counter }}" {% if form.laminat.value == value %}checked{% endif %}>
                                            <label class="form-check-label" for="id_laminat_{{ forloop.counter }}">{{ label }}</label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% if form.laminat.errors %}
                                    <div class="text-danger small">{{ form.laminat.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12 form-field">
                            <label class="form-label">{{ form.ready_deadline.label }}</label>
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                {% for value, label in form.fields.ready_deadline.widget.choices %}
                                    {% if value %}
                                    <div class="form-check">
                                        <input class="form-check-input deselect-radio" type="radio" name="ready_deadline" value="{{ value }}" id="id_ready_{{ forloop.counter }}" {% if form.ready_deadline.value == value %}checked{% endif %}>
                                        <label class="form-check-label" for="id_ready_{{ forloop.counter }}">{{ label }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                <div class="form-check ms-2">
                                    {{ form.ready_deadline_uncertain }}
                                    <label class="form-check-label" for="id_ready_deadline_uncertain">Hali tuzattirishi aniq emas</label>
                                </div>
                            </div>
                            {% if form.ready_deadline.errors %}
                                <div class="text-danger small">{{ form.ready_deadline.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12 form-field">
                            <label class="form-label">{{ form.notes.label }}</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12 form-field">
                            <label class="form-label">{{ form.client_name.label }}</label>
                            {{ form.client_name }}
                            {% if form.client_name.errors %}
                                <div class="text-danger small">{{ form.client_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Saqlash
                        </button>
                        <a href="{% url 'repairs:order_list' %}" class="btn btn-outline-secondary">Bekor qilish</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleLaminatSection() {
    const screenChecked = document.querySelector('input[name="screen_type"]:checked');
    const laminatSection = document.getElementById('laminat-section');
    if (screenChecked && screenChecked.value) {
        laminatSection.classList.remove('laminat-hidden');
    } else {
        laminatSection.classList.add('laminat-hidden');
        document.querySelectorAll('.laminat-radio').forEach(r => r.checked = false);
        const form = document.querySelector('form');
        let hidden = form.querySelector('input[type="hidden"][data-deselect="laminat"]');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'laminat';
            hidden.value = '';
            hidden.dataset.deselect = 'laminat';
            form.appendChild(hidden);
        }
    }
}

document.querySelectorAll('.deselect-radio').forEach(radio => {
    radio.addEventListener('mousedown', function() {
        this.dataset.wasChecked = this.checked;
    });
    radio.addEventListener('click', function(e) {
        if (this.dataset.wasChecked === 'true') {
            this.checked = false;
            delete this.dataset.wasChecked;
            const name = this.name;
            const form = this.closest('form');
            let hidden = form.querySelector(`input[type="hidden"][data-deselect="${name}"]`);
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = name;
                hidden.value = '';
                hidden.dataset.deselect = name;
                form.appendChild(hidden);
            }
            if (name === 'screen_type') toggleLaminatSection();
        } else {
            const name = this.name;
            const form = this.closest('form');
            const hidden = form.querySelector(`input[type="hidden"][data-deselect="${name}"]`);
            if (hidden) hidden.remove();
            if (name === 'screen_type') toggleLaminatSection();
        }
    });
});

document.querySelectorAll('input[name="screen_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked && this.value) toggleLaminatSection();
    });
});

document.addEventListener('DOMContentLoaded', toggleLaminatSection);

// Autocomplete - telefon modeli va zapchast
(function() {
    var AC_URL = '{% url "repairs:autocomplete" %}';
    var debounceTimer;

    function setupAutocomplete(inputId, suggestId, field) {
        var input = document.getElementById(inputId);
        var list = document.getElementById(suggestId);
        if (!input || !list) return;

        function getCurrentPart() {
            var val = input.value;
            var cursor = input.selectionStart || val.length;
            var lastComma = val.lastIndexOf(',', cursor - 1);
            var start = (lastComma >= 0) ? lastComma + 1 : 0;
            while (start < val.length && val[start] === ' ') start++;
            return { word: val.substring(start, cursor).trim(), start: start, end: cursor };
        }

        function applySuggestion(text, isParts) {
            if (isParts) {
                var p = getCurrentPart();
                var val = input.value;
                input.value = val.substring(0, p.start) + text + val.substring(p.end);
            } else {
                input.value = text;
            }
            list.classList.remove('show');
            list.innerHTML = '';
        }

        function fetchSuggestions(q, callback) {
            if (q.length < 1) { callback([]); return; }
            var xhr = new XMLHttpRequest();
            xhr.open('GET', AC_URL + '?field=' + field + '&q=' + encodeURIComponent(q));
            xhr.onload = function() {
                try {
                    var data = JSON.parse(xhr.responseText);
                    callback(data.results || []);
                } catch(e) { callback([]); }
            };
            xhr.onerror = function() { callback([]); };
            xhr.send();
        }

        function showList(items) {
            list.innerHTML = '';
            if (items.length === 0) { list.classList.remove('show'); return; }
            items.forEach(function(item, i) {
                var div = document.createElement('div');
                div.className = 'item';
                div.textContent = item;
                div.dataset.value = item;
                div.addEventListener('click', function() {
                    applySuggestion(item, field === 'required_parts');
                });
                list.appendChild(div);
            });
            list.classList.add('show');
        }

        input.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            var q = (field === 'required_parts') ? getCurrentPart().word : input.value.trim();
            if (q.length < 1) { list.classList.remove('show'); list.innerHTML = ''; return; }
            debounceTimer = setTimeout(function() {
                fetchSuggestions(q, showList);
            }, 200);
        });

        input.addEventListener('focus', function() {
            var q = (field === 'required_parts') ? getCurrentPart().word : input.value.trim();
            if (q.length >= 1 && list.children.length) list.classList.add('show');
        });

        input.addEventListener('blur', function() {
            setTimeout(function() { list.classList.remove('show'); }, 200);
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { list.classList.remove('show'); }
            if (!list.classList.contains('show') || list.children.length === 0) return;
            var items = list.querySelectorAll('.item');
            var active = list.querySelector('.item.active');
            var idx = active ? Array.prototype.indexOf.call(items, active) : -1;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                idx = (idx + 1) % items.length;
                items[idx].classList.add('active');
                if (active) active.classList.remove('active');
                items[idx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                idx = idx <= 0 ? items.length - 1 : idx - 1;
                items[idx].classList.add('active');
                if (active) active.classList.remove('active');
                items[idx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter' && active) {
                e.preventDefault();
                applySuggestion(active.dataset.value, field === 'required_parts');
            }
        });

        document.addEventListener('click', function(e) {
            if (!list.contains(e.target) && e.target !== input) list.classList.remove('show');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupAutocomplete('id_phone_model', 'phone_model_suggest', 'phone_model');
        setupAutocomplete('id_required_parts', 'required_parts_suggest', 'required_parts');
    });
})();
</script>
{% endblock %}
